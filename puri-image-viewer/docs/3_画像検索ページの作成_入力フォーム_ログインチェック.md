# 3. 画像検索ページの作成: 入力フォーム~ログインチェック
まずは画像検索ページの作成を行います。

## イメージ
![Step1](./img/Step3.png)

## ページの作成
ログインページと同様にNext.jsのルーティング機能を使用して、ルートパスに対応するページを作成します。  
`puri-image-viewer/apps/web/src/app`ディレクトリの配下に`page.tsx`ファイルと`page.module.scss`ファイルを作成してください。  
`page.tsx`と`page.module.scss`に下記の内容を実装します。

**app/page.tsx**
```ts
'use client';

import styles from './page.module.scss';
import { useCallback, useState } from 'react';

export default function Page() {
    const [inputSealId, setInputSealId] = useState('');
    const handleSubmit = useCallback((e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();
        console.log('searching...', inputSealId);
    }, [inputSealId]);

    return (
        <div className={styles.container}>
            <form className={styles.form} onSubmit={handleSubmit}>
                <input
                    id="sealId"
                    type="text"
                    placeholder="id"
                    onChange={(e) => setInputSealId(e.target.value)}
                    className={styles.input}
                />
                <button className={styles.button} type='submit'>Search</button>
            </form>
        </div>
    );
};

```

**app/page.module.scss**
```scss
@import 'variables';

.container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    background-color: var(--background-color);
    background-size: cover;
    background-position: center;
    padding: 2rem;
    transition: background-color 0.3s ease;
}

.form {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-direction: row;

    .input {
        width: 100%;
        border-radius: calc(0.5rem + $font-size);
        border-width: 0.075rem;
        border-style: solid;
        font-size: $font-size;
        padding: 0.5rem 1rem;
        background-color: transparent;
    }

    .button[type="submit"] {
        margin-left: 1rem;
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        
        cursor: pointer;
        transition: background-color 0.3s ease;
        border-style: solid;
        border-width: 0.1rem;
        border-radius: calc(0.5rem + $font-size);
        font-size: $font-size;
        padding: 0.5rem 1rem;
    
        &:active {
            background-color: var(--focus-primary-color);
            border-color: var(--focus-primary-color);
        }
        &:disabled {
            cursor: not-allowed;
        }
    }
}å

```

`pnpm dev`によってローカルサーバーを起動した状態で、`http://localhost:3000`にアクセスすると、上記で作成したページが表示されます。

---

## ログイン後のページ遷移

画像検索ページが作成できたので、先ほど作成したログインページからの遷移を実装します。  
下記のように`puri-image-viewer/apps/web/src/app/login/page.tsx`を修正して、ログインが成功した場合は画像検索ページに遷移するようにします。

**app/login/page.tsx**
```ts
'use client';

import { useCallback, useState } from "react";
import { useStore } from "zustand";
import authStore from "@web/stores/authStore";
import styles from './page.module.scss';
// Next.jsが提供するuseRouterは、プログラムによるナビゲーションを可能にします。
// このHook関数を使用することで、ページ間の遷移やURLの操作を簡単に行うことができます。
import { useRouter } from "next/navigation";

export default function Page() {
    const router = useRouter();
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');

    const login = useStore(authStore, (state) => state.login);
    const onSubmit = useCallback(async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();

        if (!username || !password) {
            alert('Username or Password is Empty.');
            return;
        }
        // pushでログイン成功時は画像検索ページ（ルートパス）に遷移させる.
        if (await login(username, password)) {
            router.push('/');
        }
    }, [login, username, password, router]);
    // 以下略
}

```

これでログインが成功した場合は、画像検索ページに遷移するようになりました。  
しかし、未ログインの状態で`http://localhost:3000`にアクセスすると画像検索ページが表示できてしまいます。  
これを防ぐために、未ログインの場合はログインページに遷移するようにします。  
また、ブラウザがリロードされた場合もログイン状態を維持するために、IDトークンをブラウザのストレージに永続化することにします。  

`puri-image-viewer/apps/web/src/stores/authStore.ts` の`createStore`の部分に下記のように実装を追加します。

**authStore.ts**
```ts
// 省略
// persistはzustandのミドルウェアで、ストレージに永続化するための機能を提供します.
import { persist } from "zustand/middleware";

const authStoreCreator: StateCreator<AuthStore> = (set) => ({
    // 省略
});

// persistを使用して、`auth`という名前でストレージに永続化することを宣言します.
const authStore = createStore(persist(authStoreCreator, { name: 'auth' }));
export default authStore;

```

これで一度ログインした後は、ブラウザをリロードしてもログイン状態を維持することができるようになりました。  
次は、`puri-image-viewer/apps/web/src/app/page.tsx`にログイン状態をチェックする処理を追加します。  

**app/page.tsx**
```ts
'use client';

import styles from './page.module.scss';
import { useCallback, useEffect, useState } from 'react';
import authStore from '@web/stores/authStore';
import { useRouter } from 'next/navigation';

export default function Page() {
    const router = useRouter();
    const [inputSealId, setInputSealId] = useState('');

    // useEffectは、コンポーネントのライフサイクルに合わせて、特定の処理を実行するためのHook関数です.
    useEffect(() => {
        // ストレージに永続化されたデータの初期化が完了したら、ログイン状態をチェックするようにします.
        authStore.persist.onFinishHydration((auth) => {
            // ログインしていない（or 期限切れの）場合はログインページに遷移するようにします.
            if (!auth.idToken || auth.idToken.expired) {
                router.replace('/login');
            }
        });
        authStore.persist.rehydrate();
    }, []);

    // 以下略
}

```

これでログインしていない場合はログインページに遷移するようになりました。  
動作確認したい場合は、Chromeのデベロッパーツールを開いて、上部の`Application`タブの`Storage/Local storage`を確認すると、  
`auth`という名前でストレージに永続化されていることが確認できるので、選択して状態を削除してからブラウザをリロードしてください。  

---

## Next

次は[画像検索ページの作成_画像一覧表示](./4_画像検索ページの作成_画像一覧表示.md)へ。
